#!/bin/sh

# a tool to maintain a set of bookmarks to directories
# NOTE!!! Because this runs as a separate executable, IT CANNOT CHANGE $PWD OF THE PARENT SHELL
# To work around that, I've added an alias for it.


export BKDIR=$HOME/.bookmark.d
mkdir -p $BKDIR

bk_usage () {
  local b=$(basename $0)
  cat <<EOF
  $b:        A directory "bookmark" manager
      -a     add a bookmark
      -A     store absolute paths
      -d     delete a bookmark
      -l     list saved bookmarks
      -f     forceful mode (overwrite existing bookmarks of the same name)
      -m     menu mode (prints the selected dir to stdout)
      -h     this help text.
  
  examples:
    $b -a -A alias ./path/to/dir
      stores a bookmark, but resolves it to an absolute path first.
    $b -d alias
      deletes the specified bookmark

EOF
}

main () {
  local mode=print force= rel=1
  while getopts :aAdlfmh Opt; do
    case $Opt in
      A) rel=0;;
      a) mode=add;;
      d) mode=del;;
      l) mode=list;;
      m) mode=menu;;
      f) force='-f';;
      h) bk_usage; exit 0;;
    esac
  done
  shift $(( OPTIND - 1 ));

  case $mode in
    print) readlink -f $BKDIR/$1;;
    del) rm -v $BKDIR/$1;;
    add) 
      dest=$2; [ $rel -lt 1 ] && dest=$(readlink -f $dest)
      ln -snv $force $dest $BKDIR/$1
      ;;
    list) list_bookmarks ${1:-'*'} ;;
    menu) 
      list_bookmarks ${1:-'*'} | column -t | cat -n >&2
      echo -en "\tSelect by number: " >&2
      read N
      list_bookmarks ${1:-'*'} | sed "${N}!d;" | cut -f 2
    ;;
  esac

}

list_bookmarks () {
  local links='*'
  cd $BKDIR;
  [ $# -gt 0 ] && links="${@}"
  stat --printf='%N\n' $links | tr -d "'\`" | sed 's/->/\t/; s/ \t /\t/;' ;
  cd $OLDPWD;
}


main $@
