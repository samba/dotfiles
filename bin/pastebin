#!/bin/bash
# Pastebin poster, by Sam Briesemeister
# Inspired by 'Jaku': http://haxbyjaku.com/haxs/posting-data-to-pastebin-with-curl/
# 2010-01-01: updated for recently-updated Pastebin API
# 	http://pastebin.com/api.php

if ! which curl >/dev/null; then
	echo "I need 'curl' to do my job..." >&2
	exit 1
fi


# DEFAULTS
def_pastebin_url=http://pastebin.com/api_public.php # the generic location
def_pastebin_fmt=text # no syntax highlighting
def_pastebin_rtn=1D # one day
def_pastebin_src='standard input' # standard input
def_pastebin_ttl=$USER # active shell user
dev_pastebin_dom=''

usage () {
cat <<EOF
	$0 [-e expiration] [-f format] [-t title] [-i input] [-d domain] [-p]

	-p: make this post private

	expiration: how long your post is kept
		values: {1D: one day; 1M: one month; N: forever}
		default: $def_pastebin_rtn

	format: the syntax highlighting used in pastebin
		values: (anything pastebin supports)
			- c, cpp, csharp 
			- bash, dff, bnf
			- javascript, css, html4strict
			- perl, php, python, ruby, rails
			- sql, mysql, plsql 
		default: $def_pastebin_fmt
			
	title: the name to assign for this post
		default: your active system username ($USER)
	
	input: where to get what I will post
		values: a filename
		default: $def_pastebin_src 

	domain: a Pastebin subdomain
		default: $def_pastebin_dom
		a value of 'befreely' would post to 'befreely.pastebin.com'

	Most values are passed directly to the Pastebin POST API:
		http://pastebin.com/api.php
EOF
}


verbose='-s';
while getopts ':e:f:t:i:d:phv' Opt; do
	case $Opt in
		e) retain="$OPTARG";;
		f) format="$OPTARG";;
		t) title="$OPTARG";;
		i) input="$OPTARG";;
		d) domain="$OPTARG";;
		p) private=1;;
		h) usage; exit 0;;
    v) verbose=-vvvv;;
	esac
done

title=${title:-$def_pastebin_ttl}
retain=${retain:-$def_pastebin_rtn} 
format=${format:-$def_pastebin_fmt}
input=${input:-$def_pastebin_src}
domain=${domain:-$dev_pastebin_dom}
private=${private:-0}

if [ "$input" = "$def_pastebin_src" ]; then
	# the standard input flag for CURL
	input='-'
fi


t=$(mktemp /tmp/pastebin.XXXXX)

curl -0 -i $verbose \
	--data-urlencode paste_code@"$input" \
	-d paste_subdomain=$domain \
	-d paste_private=$private \
	-d paste_expire_date=$retain \
	-d paste_name="$title" \
	-d paste_format=$format \
	$def_pastebin_url 2>&1 >$t

grep ^http $t
r=$?

if [ $r -ne 0 ]; then
	cat $t
	echo ''
fi


rm $t

exit $r

